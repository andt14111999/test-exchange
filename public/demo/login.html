<!DOCTYPE html>
<html>
  <head>
    <title>Login - SnowFox Exchange</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      .loading {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        justify-content: center;
        align-items: center;
      }
      .loading.active {
        display: flex;
      }
      .spinner {
        width: 40px;
        height: 40px;
        border: 4px solid #f3f3f3;
        border-top: 4px solid #3498db;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
    </style>
  </head>
  <body class="bg-gray-100 h-screen flex items-center justify-center">
    <div class="loading">
      <div class="spinner"></div>
    </div>

    <div class="bg-white p-8 rounded-lg shadow-lg w-full max-w-md">
      <!-- Login State -->
      <div id="loginState" class="hidden">
        <div class="flex items-center justify-between mb-6">
          <div class="flex items-center space-x-4">
            <img
              id="userAvatar"
              class="w-12 h-12 rounded-full"
              src=""
              alt="User avatar"
            />
            <div>
              <h2
                id="userName"
                class="text-lg font-semibold text-gray-800"
              ></h2>
              <p id="userEmail" class="text-sm text-gray-600"></p>
            </div>
          </div>
          <button
            onclick="handleLogout()"
            class="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600 transition-colors"
          >
            Logout
          </button>
        </div>
        <div class="border-t pt-4">
          <h3 class="font-semibold mb-2">Account Status</h3>
          <div class="space-y-2">
            <div id="roleStatus" class="flex items-center"></div>
            <div id="kycStatus" class="flex items-center"></div>
            <div
              id="verificationStatus"
              class="flex items-center space-x-2"
            ></div>
          </div>
        </div>
        <div class="mt-4">
          <button
            onclick="window.location.href='/demo/balance.html'"
            class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded"
          >
            View Balances
          </button>
        </div>
      </div>

      <!-- Login Form -->
      <div id="loginForm">
        <div class="text-center mb-8">
          <h1 class="text-2xl font-bold text-gray-800">Welcome to SnowFox</h1>
          <p class="text-gray-600 mt-2">Please select your account type</p>
        </div>

        <!-- Account Type Selection -->
        <div class="mb-6 space-y-4">
          <div class="flex justify-center space-x-4">
            <button
              onclick="selectAccountType('user')"
              class="account-type-btn flex-1 p-4 border rounded-lg hover:bg-gray-50 transition-colors"
              data-type="user"
            >
              <div class="text-center">
                <svg
                  class="w-8 h-8 mx-auto mb-2"
                  fill="currentColor"
                  viewBox="0 0 20 20"
                >
                  <path
                    d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z"
                  ></path>
                </svg>
                <span class="block font-medium">Regular User</span>
              </div>
            </button>
            <button
              onclick="selectAccountType('merchant')"
              class="account-type-btn flex-1 p-4 border rounded-lg hover:bg-gray-50 transition-colors"
              data-type="merchant"
            >
              <div class="text-center">
                <svg
                  class="w-8 h-8 mx-auto mb-2"
                  fill="currentColor"
                  viewBox="0 0 20 20"
                >
                  <path d="M4 4a2 2 0 00-2 2v1h16V6a2 2 0 00-2-2H4z"></path>
                  <path
                    fill-rule="evenodd"
                    d="M18 9H2v5a2 2 0 002 2h12a2 2 0 002-2V9zM4 13a1 1 0 011-1h1a1 1 0 110 2H5a1 1 0 01-1-1zm5-1a1 1 0 100 2h1a1 1 0 100-2H9z"
                    clip-rule="evenodd"
                  ></path>
                </svg>
                <span class="block font-medium">Merchant</span>
              </div>
            </button>
          </div>
        </div>

        <!-- Google Sign-In Button - Initially Hidden -->
        <div id="googleSignInWrapper" class="hidden">
          <div class="text-center mb-4">
            <p class="text-sm text-gray-600">
              Selected:
              <span id="selectedAccountType" class="font-medium"></span>
            </p>
            <button
              onclick="resetSelection()"
              class="text-sm text-blue-600 hover:underline"
            >
              Change Selection
            </button>
          </div>
          <div class="flex justify-center">
            <div
              id="g_id_onload"
              data-client_id="56825300991-gog78mav6k5ol8vil291dmil9if0lv0c.apps.googleusercontent.com"
              data-callback="handleCredentialResponse"
              data-auto_prompt="false"
            ></div>
            <div
              class="g_id_signin"
              data-type="standard"
              data-size="large"
              data-theme="outline"
              data-text="sign_in_with"
              data-shape="rectangular"
              data-logo_alignment="left"
            ></div>
          </div>
        </div>
      </div>

      <!-- Status Messages -->
      <div id="statusMessage" class="hidden rounded-md p-4 mb-4"></div>
    </div>

    <script>
      const API_URL = "http://localhost:3969/api/v1/auth/google";
      const loading = document.querySelector(".loading");
      const statusMessage = document.getElementById("statusMessage");
      const loginForm = document.getElementById("loginForm");
      const loginState = document.getElementById("loginState");
      const googleSignInWrapper = document.getElementById(
        "googleSignInWrapper"
      );
      let selectedAccountType = null;

      function showLoading() {
        loading.classList.add("active");
      }

      function hideLoading() {
        loading.classList.remove("active");
      }

      function showMessage(message, type = "success") {
        statusMessage.classList.remove(
          "hidden",
          "bg-green-100",
          "bg-red-100",
          "text-green-700",
          "text-red-700"
        );

        if (type === "success") {
          statusMessage.classList.add("bg-green-100", "text-green-700");
        } else {
          statusMessage.classList.add("bg-red-100", "text-red-700");
        }

        statusMessage.textContent = message;
      }

      function updateUIWithUserData(user) {
        document.getElementById("userAvatar").src = user.avatar_url;
        document.getElementById("userName").textContent = user.display_name;
        document.getElementById("userEmail").textContent = user.email;

        // Role status
        document.getElementById("roleStatus").innerHTML = `
          <span class="text-gray-600 mr-2">Role:</span>
          <span class="px-2 py-1 rounded text-sm ${
            user.role === "admin"
              ? "bg-purple-100 text-purple-800"
              : "bg-blue-100 text-blue-800"
          }">${user.role}</span>
        `;

        // KYC status
        document.getElementById("kycStatus").innerHTML = `
          <span class="text-gray-600 mr-2">KYC Level:</span>
          <span class="px-2 py-1 rounded text-sm ${
            user.kyc_level > 0
              ? "bg-green-100 text-green-800"
              : "bg-yellow-100 text-yellow-800"
          }">${user.kyc_level}</span>
        `;

        // Verification status
        const verificationHTML = [];
        if (user.phone_verified) {
          verificationHTML.push(
            '<span class="px-2 py-1 rounded text-sm bg-green-100 text-green-800">Phone Verified</span>'
          );
        }
        if (user.document_verified) {
          verificationHTML.push(
            '<span class="px-2 py-1 rounded text-sm bg-green-100 text-green-800">Document Verified</span>'
          );
        }
        if (!user.phone_verified && !user.document_verified) {
          verificationHTML.push(
            '<span class="px-2 py-1 rounded text-sm bg-yellow-100 text-yellow-800">Verification Required</span>'
          );
        }
        document.getElementById("verificationStatus").innerHTML =
          verificationHTML.join(" ");

        loginForm.classList.add("hidden");
        loginState.classList.remove("hidden");
      }

      function handleLogout() {
        localStorage.removeItem("auth_token");
        localStorage.removeItem("user");
        loginState.classList.add("hidden");
        loginForm.classList.remove("hidden");
        showMessage("Logged out successfully");
      }

      function selectAccountType(type) {
        selectedAccountType = type;
        document.getElementById("selectedAccountType").textContent =
          type === "merchant" ? "Merchant Account" : "Regular User Account";

        // Highlight selected button
        document.querySelectorAll(".account-type-btn").forEach((btn) => {
          if (btn.dataset.type === type) {
            btn.classList.add("border-blue-500", "bg-blue-50");
          } else {
            btn.classList.remove("border-blue-500", "bg-blue-50");
          }
        });

        // Show Google Sign-In
        googleSignInWrapper.classList.remove("hidden");
      }

      function resetSelection() {
        selectedAccountType = null;
        googleSignInWrapper.classList.add("hidden");
        document.querySelectorAll(".account-type-btn").forEach((btn) => {
          btn.classList.remove("border-blue-500", "bg-blue-50");
        });
      }

      async function handleCredentialResponse(response) {
        if (!selectedAccountType) {
          showMessage("Please select an account type first", "error");
          return;
        }

        showLoading();

        try {
          const result = await fetch(API_URL, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Accept: "application/json",
            },
            body: JSON.stringify({
              id_token: response.credential,
              account_type: selectedAccountType,
            }),
          });

          const data = await result.json();

          if (result.ok) {
            localStorage.setItem("auth_token", data.token);
            localStorage.setItem("user", JSON.stringify(data.user));
            localStorage.setItem("account_type", selectedAccountType);

            updateUIWithUserData(data.user);
            showMessage(`Login successful as ${selectedAccountType}!`);
          } else {
            throw new Error(data.error || "Authentication failed");
          }
        } catch (error) {
          showMessage(error.message, "error");
          resetSelection();
        } finally {
          hideLoading();
        }
      }

      // Check login state on page load
      document.addEventListener("DOMContentLoaded", () => {
        const token = localStorage.getItem("auth_token");
        const user = localStorage.getItem("user");
        const savedAccountType = localStorage.getItem("account_type");

        if (token && user) {
          try {
            const userData = JSON.parse(user);
            updateUIWithUserData(userData);
            if (savedAccountType) {
              selectedAccountType = savedAccountType;
            }
          } catch (error) {
            console.error("Error parsing user data:", error);
            handleLogout();
          }
        }
      });
    </script>
  </body>
</html>
